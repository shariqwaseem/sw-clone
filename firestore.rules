rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    match /groups/{groupId} {
      function memberDoc(uid) {
        return /databases/$(database)/documents/groups/$(groupId)/members/$(uid);
      }

      function isMember() {
        return isSignedIn() && exists(memberDoc(request.auth.uid));
      }

      function isSelfJoin() {
        return isSignedIn() &&
          resource.data.memberIds != null &&
          request.resource.data.memberIds != null &&
          request.resource.data.memberIds.hasAll(resource.data.memberIds) &&
          request.resource.data.memberIds.size() == resource.data.memberIds.size() + 1 &&
          !resource.data.memberIds.hasAny([request.auth.uid]) &&
          request.resource.data.memberIds.hasAny([request.auth.uid]) &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['memberIds']);
      }

      allow read: if isMember();
      allow create: if isSignedIn();
      allow update: if isMember() || isSelfJoin();

      match /members/{uid} {
        allow read: if isMember();
        allow create: if isMember() || (isSignedIn() && request.auth.uid == uid);
        allow update: if isMember();
      }

      match /expenses/{expenseId} {
        function validExpense(data) {
          return data.totalAmount > 0 &&
            data.payers.size() > 0 &&
            data.splits.size() > 0 &&
            data.payers.values().all(p => p.amount >= 0 && exists(memberDoc(p.uid))) &&
            data.splits.values().all(s => s.amount >= 0 && exists(memberDoc(s.uid))) &&
            data.currency == get(/databases/$(database)/documents/groups/$(groupId)).data.currency;
        }

        allow read: if isMember();
        allow create: if isMember() && validExpense(request.resource.data);
        allow update: if isMember() && validExpense(request.resource.data);
      }

      match /payments/{paymentId} {
        function validPayment(data) {
          return data.amount > 0 &&
            data.fromUid != data.toUid &&
            exists(memberDoc(data.fromUid)) &&
            exists(memberDoc(data.toUid));
        }

        allow read: if isMember();
        allow create: if isMember() && validPayment(request.resource.data);
        allow update: if isMember() && validPayment(request.resource.data);
      }
    }
  }
}
